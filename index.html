<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>English Gacha World DX</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @keyframes float {
            0% { transform: translateY(0px); }
            100% { transform: translateY(-20px); }
        }
        @keyframes spin-slow {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        .animate-spin-slow {
            animation: spin-slow 10s linear infinite;
        }
        /* Gacha animation classes */
        .gacha-shake {
            animation: shake 0.5s cubic-bezier(.36,.07,.19,.97) both;
        }
        @keyframes shake {
            10%, 90% { transform: translate3d(-1px, 0, 0); }
            20%, 80% { transform: translate3d(2px, 0, 0); }
            30%, 50%, 70% { transform: translate3d(-4px, 0, 0); }
            40%, 60% { transform: translate3d(4px, 0, 0); }
        }
        /* Custom Scrollbar for collection */
        .collection-scroll::-webkit-scrollbar {
            width: 8px;
        }
        .collection-scroll::-webkit-scrollbar-track {
            background: #f1f1f1; 
        }
        .collection-scroll::-webkit-scrollbar-thumb {
            background: #c7c7c7; 
            border-radius: 4px;
        }
        .collection-scroll::-webkit-scrollbar-thumb:hover {
            background: #a8a8a8; 
        }
    </style>
</head>
<body class="bg-indigo-50 min-h-screen font-sans select-none touch-manipulation overflow-hidden">

    <div id="app" class="max-w-md mx-auto h-screen bg-indigo-50 relative shadow-2xl overflow-hidden flex flex-col">
        <!-- Content will be rendered here by JavaScript -->
    </div>

<script>
    // --- ãƒ‡ãƒ¼ã‚¿å®šç¾© (å…¨100å˜èª) ---
    // Rarity 1: Common (50%)
    // Rarity 2: Rare (30%)
    // Rarity 3: Super Rare (15%)
    // Rarity 4: Ultra Rare (5%)
    const VOCABULARY = [
        // --- Common (â˜…1) Everyday Items ---
        { id: 'apple', word: 'Apple', jp: 'ã‚Šã‚“ã”', icon: 'ğŸ', rarity: 1, bg: 'bg-red-50' },
        { id: 'banana', word: 'Banana', jp: 'ãƒãƒŠãƒŠ', icon: 'ğŸŒ', rarity: 1, bg: 'bg-yellow-50' },
        { id: 'orange', word: 'Orange', jp: 'ã¿ã‹ã‚“', icon: 'ğŸŠ', rarity: 1, bg: 'bg-orange-50' },
        { id: 'cat', word: 'Cat', jp: 'ã­ã“', icon: 'ğŸ±', rarity: 1, bg: 'bg-orange-50' },
        { id: 'dog', word: 'Dog', jp: 'ã„ã¬', icon: 'ğŸ¶', rarity: 1, bg: 'bg-amber-50' },
        { id: 'pig', word: 'Pig', jp: 'ã¶ãŸ', icon: 'ğŸ·', rarity: 1, bg: 'bg-pink-50' },
        { id: 'cow', word: 'Cow', jp: 'ã†ã—', icon: 'ğŸ®', rarity: 1, bg: 'bg-stone-50' },
        { id: 'mouse', word: 'Mouse', jp: 'ã­ãšã¿', icon: 'ğŸ­', rarity: 1, bg: 'bg-stone-100' },
        { id: 'egg', word: 'Egg', jp: 'ãŸã¾ã”', icon: 'ğŸ¥š', rarity: 1, bg: 'bg-yellow-50' },
        { id: 'milk', word: 'Milk', jp: 'ãã‚…ã†ã«ã‚…ã†', icon: 'ğŸ¥›', rarity: 1, bg: 'bg-blue-50' },
        { id: 'bread', word: 'Bread', jp: 'ãƒ‘ãƒ³', icon: 'ğŸ', rarity: 1, bg: 'bg-orange-50' },
        { id: 'rice', word: 'Rice', jp: 'ã”ã¯ã‚“', icon: 'ğŸš', rarity: 1, bg: 'bg-white' },
        { id: 'ball', word: 'Ball', jp: 'ãƒœãƒ¼ãƒ«', icon: 'âš½', rarity: 1, bg: 'bg-stone-50' },
        { id: 'book', word: 'Book', jp: 'ã»ã‚“', icon: 'ğŸ“š', rarity: 1, bg: 'bg-blue-50' },
        { id: 'pen', word: 'Pen', jp: 'ãƒšãƒ³', icon: 'ğŸ–Šï¸', rarity: 1, bg: 'bg-slate-50' },
        { id: 'pencil', word: 'Pencil', jp: 'ãˆã‚“ã´ã¤', icon: 'âœï¸', rarity: 1, bg: 'bg-yellow-50' },
        { id: 'shirt', word: 'Shirt', jp: 'ã‚·ãƒ£ãƒ„', icon: 'ğŸ‘•', rarity: 1, bg: 'bg-cyan-50' },
        { id: 'shoes', word: 'Shoes', jp: 'ãã¤', icon: 'ğŸ‘Ÿ', rarity: 1, bg: 'bg-red-50' },
        { id: 'socks', word: 'Socks', jp: 'ãã¤ã—ãŸ', icon: 'ğŸ§¦', rarity: 1, bg: 'bg-green-50' },
        { id: 'hat', word: 'Hat', jp: 'ã¼ã†ã—', icon: 'ğŸ§¢', rarity: 1, bg: 'bg-blue-100' },
        { id: 'car', word: 'Car', jp: 'ãã‚‹ã¾', icon: 'ğŸš—', rarity: 1, bg: 'bg-red-100' },
        { id: 'bus', word: 'Bus', jp: 'ãƒã‚¹', icon: 'ğŸšŒ', rarity: 1, bg: 'bg-yellow-100' },
        { id: 'taxi', word: 'Taxi', jp: 'ã‚¿ã‚¯ã‚·ãƒ¼', icon: 'ğŸš•', rarity: 1, bg: 'bg-yellow-50' },
        { id: 'flower', word: 'Flower', jp: 'ãŠã¯ãª', icon: 'ğŸŒ·', rarity: 1, bg: 'bg-pink-50' },
        { id: 'tree', word: 'Tree', jp: 'ã', icon: 'ğŸŒ³', rarity: 1, bg: 'bg-green-100' },
        { id: 'sun', word: 'Sun', jp: 'ãŸã„ã‚ˆã†', icon: 'â˜€ï¸', rarity: 1, bg: 'bg-orange-100' },
        { id: 'cloud', word: 'Cloud', jp: 'ãã‚‚', icon: 'â˜ï¸', rarity: 1, bg: 'bg-gray-100' },
        { id: 'umbrella', word: 'Umbrella', jp: 'ã‹ã•', icon: 'â˜‚ï¸', rarity: 1, bg: 'bg-purple-50' },
        { id: 'fish', word: 'Fish', jp: 'ã•ã‹ãª', icon: 'ğŸŸ', rarity: 1, bg: 'bg-blue-50' },
        { id: 'bug', word: 'Bug', jp: 'ã‚€ã—', icon: 'ğŸ›', rarity: 1, bg: 'bg-green-50' },
        { id: 'ant', word: 'Ant', jp: 'ã‚ã‚Š', icon: 'ğŸœ', rarity: 1, bg: 'bg-stone-200' },
        { id: 'eye', word: 'Eye', jp: 'ã‚', icon: 'ğŸ‘ï¸', rarity: 1, bg: 'bg-stone-50' },
        { id: 'ear', word: 'Ear', jp: 'ã¿ã¿', icon: 'ğŸ‘‚', rarity: 1, bg: 'bg-orange-50' },
        { id: 'mouth', word: 'Mouth', jp: 'ãã¡', icon: 'ğŸ‘„', rarity: 1, bg: 'bg-pink-50' },
        { id: 'hand', word: 'Hand', jp: 'ã¦', icon: 'âœ‹', rarity: 1, bg: 'bg-orange-50' },
        { id: 'door', word: 'Door', jp: 'ãƒ‰ã‚¢', icon: 'ğŸšª', rarity: 1, bg: 'bg-yellow-100' },
        { id: 'bed', word: 'Bed', jp: 'ãƒ™ãƒƒãƒ‰', icon: 'ğŸ›ï¸', rarity: 1, bg: 'bg-blue-50' },
        { id: 'bath', word: 'Bath', jp: 'ãŠãµã‚', icon: 'ğŸ›', rarity: 1, bg: 'bg-cyan-50' },
        { id: 'clock', word: 'Clock', jp: 'ã¨ã‘ã„', icon: 'â°', rarity: 1, bg: 'bg-red-50' },
        { id: 'phone', word: 'Phone', jp: 'ã§ã‚“ã‚', icon: 'ğŸ“±', rarity: 1, bg: 'bg-slate-100' },

        // --- Rare (â˜…2) Fun Things ---
        { id: 'grape', word: 'Grape', jp: 'ã¶ã©ã†', icon: 'ğŸ‡', rarity: 2, bg: 'bg-purple-100' },
        { id: 'strawberry', word: 'Strawberry', jp: 'ã„ã¡ã”', icon: 'ğŸ“', rarity: 2, bg: 'bg-red-100' },
        { id: 'melon', word: 'Melon', jp: 'ãƒ¡ãƒ­ãƒ³', icon: 'ğŸˆ', rarity: 2, bg: 'bg-green-100' },
        { id: 'peach', word: 'Peach', jp: 'ã‚‚ã‚‚', icon: 'ğŸ‘', rarity: 2, bg: 'bg-pink-100' },
        { id: 'cherry', word: 'Cherry', jp: 'ã•ãã‚‰ã‚“ã¼', icon: 'ğŸ’', rarity: 2, bg: 'bg-rose-100' },
        { id: 'lion', word: 'Lion', jp: 'ãƒ©ã‚¤ã‚ªãƒ³', icon: 'ğŸ¦', rarity: 2, bg: 'bg-yellow-100' },
        { id: 'tiger', word: 'Tiger', jp: 'ã¨ã‚‰', icon: 'ğŸ¯', rarity: 2, bg: 'bg-orange-200' },
        { id: 'bear', word: 'Bear', jp: 'ãã¾', icon: 'ğŸ»', rarity: 2, bg: 'bg-amber-200' },
        { id: 'panda', word: 'Panda', jp: 'ãƒ‘ãƒ³ãƒ€', icon: 'ğŸ¼', rarity: 2, bg: 'bg-stone-100' },
        { id: 'koala', word: 'Koala', jp: 'ã‚³ã‚¢ãƒ©', icon: 'ğŸ¨', rarity: 2, bg: 'bg-slate-200' },
        { id: 'rabbit', word: 'Rabbit', jp: 'ã†ã•ã', icon: 'ğŸ°', rarity: 2, bg: 'bg-pink-50' },
        { id: 'frog', word: 'Frog', jp: 'ã‹ãˆã‚‹', icon: 'ğŸ¸', rarity: 2, bg: 'bg-green-100' },
        { id: 'turtle', word: 'Turtle', jp: 'ã‹ã‚', icon: 'ğŸ¢', rarity: 2, bg: 'bg-emerald-100' },
        { id: 'penguin', word: 'Penguin', jp: 'ãƒšãƒ³ã‚®ãƒ³', icon: 'ğŸ§', rarity: 2, bg: 'bg-blue-100' },
        { id: 'octopus', word: 'Octopus', jp: 'ãŸã“', icon: 'ğŸ™', rarity: 2, bg: 'bg-red-100' },
        { id: 'burger', word: 'Burger', jp: 'ãƒãƒ³ãƒãƒ¼ã‚¬ãƒ¼', icon: 'ğŸ”', rarity: 2, bg: 'bg-orange-100' },
        { id: 'fries', word: 'Fries', jp: 'ãƒãƒ†ãƒˆ', icon: 'ğŸŸ', rarity: 2, bg: 'bg-yellow-100' },
        { id: 'pizza', word: 'Pizza', jp: 'ãƒ”ã‚¶', icon: 'ğŸ•', rarity: 2, bg: 'bg-orange-50' },
        { id: 'donut', word: 'Donut', jp: 'ãƒ‰ãƒ¼ãƒŠãƒ„', icon: 'ğŸ©', rarity: 2, bg: 'bg-pink-100' },
        { id: 'cookie', word: 'Cookie', jp: 'ã‚¯ãƒƒã‚­ãƒ¼', icon: 'ğŸª', rarity: 2, bg: 'bg-amber-100' },
        { id: 'icecream', word: 'Ice Cream', jp: 'ã‚¢ã‚¤ã‚¹', icon: 'ğŸ¦', rarity: 2, bg: 'bg-sky-50' },
        { id: 'cake', word: 'Cake', jp: 'ã‚±ãƒ¼ã‚­', icon: 'ğŸ°', rarity: 2, bg: 'bg-rose-50' },
        { id: 'chocolate', word: 'Chocolate', jp: 'ãƒãƒ§ã‚³', icon: 'ğŸ«', rarity: 2, bg: 'bg-stone-300' },
        { id: 'candy', word: 'Candy', jp: 'ã‚­ãƒ£ãƒ³ãƒ‡ã‚£', icon: 'ğŸ¬', rarity: 2, bg: 'bg-purple-50' },
        { id: 'train', word: 'Train', jp: 'ã§ã‚“ã—ã‚ƒ', icon: 'ğŸšƒ', rarity: 2, bg: 'bg-green-100' },
        { id: 'bike', word: 'Bike', jp: 'ã˜ã¦ã‚“ã—ã‚ƒ', icon: 'ğŸš²', rarity: 2, bg: 'bg-blue-50' },
        { id: 'boat', word: 'Boat', jp: 'ãƒœãƒ¼ãƒˆ', icon: 'ğŸš¤', rarity: 2, bg: 'bg-cyan-100' },
        { id: 'truck', word: 'Truck', jp: 'ãƒˆãƒ©ãƒƒã‚¯', icon: 'ğŸšš', rarity: 2, bg: 'bg-slate-200' },
        { id: 'police', word: 'Police Car', jp: 'ãƒ‘ãƒˆã‚«ãƒ¼', icon: 'ğŸš“', rarity: 2, bg: 'bg-stone-100' },
        { id: 'fire', word: 'Fire Engine', jp: 'ã—ã‚‡ã†ã¼ã†ã—ã‚ƒ', icon: 'ğŸš’', rarity: 2, bg: 'bg-red-200' },
        { id: 'ambulance', word: 'Ambulance', jp: 'ãã‚…ã†ãã‚…ã†ã—ã‚ƒ', icon: 'ğŸš‘', rarity: 2, bg: 'bg-slate-50' },
        { id: 'moon', word: 'Moon', jp: 'ã¤ã', icon: 'ğŸŒ™', rarity: 2, bg: 'bg-indigo-100' },
        { id: 'star', word: 'Star', jp: 'ã»ã—', icon: 'â­', rarity: 2, bg: 'bg-yellow-100' },
        { id: 'camera', word: 'Camera', jp: 'ã‚«ãƒ¡ãƒ©', icon: 'ğŸ“·', rarity: 2, bg: 'bg-stone-200' },
        { id: 'computer', word: 'Computer', jp: 'ãƒ‘ã‚½ã‚³ãƒ³', icon: 'ğŸ’»', rarity: 2, bg: 'bg-slate-200' },
        { id: 'robot', word: 'Robot', jp: 'ãƒ­ãƒœãƒƒãƒˆ', icon: 'ğŸ¤–', rarity: 2, bg: 'bg-gray-200' },
        { id: 'music', word: 'Music', jp: 'ãŠã‚“ãŒã', icon: 'ğŸµ', rarity: 2, bg: 'bg-pink-100' },
        { id: 'balloon', word: 'Balloon', jp: 'ãµã†ã›ã‚“', icon: 'ğŸˆ', rarity: 2, bg: 'bg-red-50' },

        // --- Super Rare (â˜…3) Cool Things ---
        { id: 'plane', word: 'Plane', jp: 'ã²ã“ã†ã', icon: 'âœˆï¸', rarity: 3, bg: 'bg-sky-200' },
        { id: 'helicopter', word: 'Helicopter', jp: 'ãƒ˜ãƒªã‚³ãƒ—ã‚¿ãƒ¼', icon: 'ğŸš', rarity: 3, bg: 'bg-stone-300' },
        { id: 'rocket', word: 'Rocket', jp: 'ãƒ­ã‚±ãƒƒãƒˆ', icon: 'ğŸš€', rarity: 3, bg: 'bg-indigo-200' },
        { id: 'ufo', word: 'UFO', jp: 'UFO', icon: 'ğŸ›¸', rarity: 3, bg: 'bg-purple-200' },
        { id: 'dinosaur', word: 'Dinosaur', jp: 'ãã‚‡ã†ã‚Šã‚…ã†', icon: 'ğŸ¦–', rarity: 3, bg: 'bg-green-200' },
        { id: 'whale', word: 'Whale', jp: 'ãã˜ã‚‰', icon: 'ğŸ³', rarity: 3, bg: 'bg-blue-200' },
        { id: 'shark', word: 'Shark', jp: 'ã•ã‚', icon: 'ğŸ¦ˆ', rarity: 3, bg: 'bg-slate-300' },
        { id: 'rainbow', word: 'Rainbow', jp: 'ã«ã˜', icon: 'ğŸŒˆ', rarity: 3, bg: 'bg-sky-100' },
        { id: 'snowman', word: 'Snowman', jp: 'ã‚†ãã ã‚‹ã¾', icon: 'â›„', rarity: 3, bg: 'bg-slate-100' },
        { id: 'ghost', word: 'Ghost', jp: 'ãŠã°ã‘', icon: 'ğŸ‘»', rarity: 3, bg: 'bg-gray-300' },
        { id: 'present', word: 'Gift', jp: 'ãƒ—ãƒ¬ã‚¼ãƒ³ãƒˆ', icon: 'ğŸ', rarity: 3, bg: 'bg-red-200' },
        { id: 'ring', word: 'Ring', jp: 'ã‚†ã³ã‚', icon: 'ğŸ’', rarity: 3, bg: 'bg-cyan-100' },
        { id: 'gem', word: 'Gem', jp: 'ã»ã†ã›ã', icon: 'ğŸ’', rarity: 3, bg: 'bg-cyan-200' },
        { id: 'trophy', word: 'Trophy', jp: 'ãƒˆãƒ­ãƒ•ã‚£ãƒ¼', icon: 'ğŸ†', rarity: 3, bg: 'bg-yellow-200' },
        { id: 'medal', word: 'Medal', jp: 'ãƒ¡ãƒ€ãƒ«', icon: 'ğŸ¥‡', rarity: 3, bg: 'bg-yellow-300' },
        
        // --- Ultra Rare (â˜…4) Legendary ---
        { id: 'dragon', word: 'Dragon', jp: 'ãƒ‰ãƒ©ã‚´ãƒ³', icon: 'ğŸ‰', rarity: 4, bg: 'bg-emerald-300' },
        { id: 'unicorn', word: 'Unicorn', jp: 'ãƒ¦ãƒ‹ã‚³ãƒ¼ãƒ³', icon: 'ğŸ¦„', rarity: 4, bg: 'bg-purple-300' },
        { id: 'alien', word: 'Alien', jp: 'ã†ã¡ã‚…ã†ã˜ã‚“', icon: 'ğŸ‘½', rarity: 4, bg: 'bg-green-300' },
        { id: 'crown', word: 'Crown', jp: 'ãŠã†ã‹ã‚“', icon: 'ğŸ‘‘', rarity: 4, bg: 'bg-yellow-400' },
        { id: 'castle', word: 'Castle', jp: 'ãŠã—ã‚', icon: 'ğŸ°', rarity: 4, bg: 'bg-stone-300' },
        { id: 'santa', word: 'Santa', jp: 'ã‚µãƒ³ã‚¿', icon: 'ğŸ…', rarity: 4, bg: 'bg-red-300' },
        { id: 'genie', word: 'Genie', jp: 'ã¾ã˜ã‚“', icon: 'ğŸ§', rarity: 4, bg: 'bg-indigo-300' },
    ];

    const GACHA_COST = 100;
    const REWARD_PER_GAME = 20; // ã‚³ã‚¤ãƒ³ç²å¾—é‡ã‚¢ãƒƒãƒ—
    const PERFECT_BONUS = 50;   // ãƒœãƒ¼ãƒŠã‚¹ã‚¢ãƒƒãƒ—

    // --- State Management ---
    let state = {
        coins: parseInt(localStorage.getItem('kids_eng_coins_dx')) || 100, // æœ€åˆã‹ã‚‰1å›å¼•ã‘ã‚‹ã‚ˆã†ã«
        collection: JSON.parse(localStorage.getItem('kids_eng_collection_dx')) || [],
        screen: 'menu', 
        gameData: null,
        gachaState: 'idle',
        gachaResult: null
    };

    // --- Helpers ---
    function saveState() {
        localStorage.setItem('kids_eng_coins_dx', state.coins);
        localStorage.setItem('kids_eng_collection_dx', JSON.stringify(state.collection));
        render();
    }

    function speak(text) {
        if (!window.speechSynthesis) return;
        window.speechSynthesis.cancel();
        const u = new SpeechSynthesisUtterance(text);
        u.lang = 'en-US';
        u.rate = 0.9; // å°‘ã—ã‚†ã£ãã‚Š
        window.speechSynthesis.speak(u);
    }

    function playSfx(type) {
        const AudioContext = window.AudioContext || window.webkitAudioContext;
        if (!AudioContext) return;
        const ctx = new AudioContext();
        const osc = ctx.createOscillator();
        const gain = ctx.createGain();
        osc.connect(gain);
        gain.connect(ctx.destination);
        const now = ctx.currentTime;

        if (type === 'pop') {
            osc.type = 'triangle';
            osc.frequency.setValueAtTime(400, now);
            osc.frequency.exponentialRampToValueAtTime(800, now + 0.1);
            gain.gain.setValueAtTime(0.1, now);
            gain.gain.linearRampToValueAtTime(0, now + 0.1);
            osc.start();
            osc.stop(now + 0.1);
        } else if (type === 'coin') {
            osc.type = 'sine';
            osc.frequency.setValueAtTime(1000, now);
            osc.frequency.setValueAtTime(1500, now + 0.1);
            gain.gain.setValueAtTime(0.1, now);
            gain.gain.linearRampToValueAtTime(0, now + 0.3);
            osc.start();
            osc.stop(now + 0.3);
        } else if (type === 'gacha') {
            osc.type = 'square';
            osc.frequency.setValueAtTime(200, now);
            osc.frequency.linearRampToValueAtTime(100, now + 0.5);
            gain.gain.setValueAtTime(0.05, now);
            gain.gain.linearRampToValueAtTime(0, now + 0.5);
            osc.start();
            osc.stop(now + 0.5);
        } else if (type === 'fanfare') {
             // ç°¡æ˜“ãƒ•ã‚¡ãƒ³ãƒ•ã‚¡ãƒ¼ãƒ¬
             osc.type = 'triangle';
             osc.frequency.setValueAtTime(523, now);
             osc.frequency.setValueAtTime(659, now + 0.1);
             osc.frequency.setValueAtTime(784, now + 0.2);
             gain.gain.setValueAtTime(0.2, now);
             gain.gain.linearRampToValueAtTime(0, now + 1.0);
             osc.start();
             osc.stop(now + 1.0);
        }
    }

    // --- Game Logic ---
    function startGame() {
        const questions = [];
        for(let i=0; i<5; i++) {
            const target = VOCABULARY[Math.floor(Math.random() * VOCABULARY.length)];
            const distractors = [];
            while(distractors.length < 2) {
                const d = VOCABULARY[Math.floor(Math.random() * VOCABULARY.length)];
                if (d.id !== target.id && !distractors.find(x => x.id === d.id)) distractors.push(d);
            }
            const options = [target, ...distractors].sort(() => 0.5 - Math.random());
            questions.push({ target, options });
        }
        
        state.gameData = { 
            questions, 
            currentIdx: 0, 
            score: 0, 
            answered: false 
        };
        state.screen = 'game';
        render();
        
        setTimeout(() => speak(questions[0].target.word), 600);
    }

    function handleBalloonClick(itemId) {
        if (state.gameData.answered) return;
        
        const currentQ = state.gameData.questions[state.gameData.currentIdx];
        const isCorrect = itemId === currentQ.target.id;
        const clickedItem = currentQ.options.find(o => o.id === itemId);

        state.gameData.answered = true;
        render(); 

        if (isCorrect) {
            playSfx('pop');
            speak("Good!");
            state.gameData.score++;
        } else {
            speak(clickedItem.word);
        }

        setTimeout(() => {
            if (state.gameData.currentIdx < 4) {
                state.gameData.currentIdx++;
                state.gameData.answered = false;
                render();
                speak(state.gameData.questions[state.gameData.currentIdx].target.word);
            } else {
                // End Game
                const finalScore = isCorrect ? state.gameData.score : state.gameData.score;
                const reward = (finalScore * REWARD_PER_GAME) + (finalScore === 5 ? PERFECT_BONUS : 0);
                
                state.coins += reward;
                if (finalScore >= 3) playSfx('fanfare');
                
                state.gameData.finalReward = reward;
                state.gameData.finalScore = finalScore;
                state.screen = 'result';
                saveState();
            }
        }, 1500);
    }

    // --- Gacha Logic ---
    function spinGacha() {
        if (state.coins < GACHA_COST || state.gachaState !== 'idle') return;
        
        state.coins -= GACHA_COST;
        state.gachaState = 'spinning';
        playSfx('gacha');
        saveState();

        setTimeout(() => {
            // Rarity Logic
            const rand = Math.random();
            let rarity = 1;
            
            if (rand < 0.50) rarity = 1; // 50% Common
            else if (rand < 0.80) rarity = 2; // 30% Rare
            else if (rand < 0.95) rarity = 3; // 15% Super Rare
            else rarity = 4; // 5% Ultra Rare

            const pool = VOCABULARY.filter(v => v.rarity === rarity);
            const result = pool[Math.floor(Math.random() * pool.length)];
            
            state.gachaResult = result;
            state.gachaState = 'open';
            
            if (!state.collection.includes(result.id)) {
                state.collection.push(result.id);
            }
            if (rarity >= 3) playSfx('fanfare');
            saveState();
        }, 2000);
    }

    function closeGacha() {
        state.gachaState = 'idle';
        state.gachaResult = null;
        render();
    }

    function resetData() {
        if(confirm('Are you sure you want to reset all data? (Coins and Collection will be lost)')) {
            state.coins = 100;
            state.collection = [];
            state.screen = 'menu';
            saveState();
        }
    }

    // --- Rendering ---
    const app = document.getElementById('app');

    function render() {
        app.innerHTML = ''; 

        if (state.screen === 'menu') renderMenu();
        else if (state.screen === 'game') renderGame();
        else if (state.screen === 'result') renderResult();
        else if (state.screen === 'gacha') renderGacha();
        else if (state.screen === 'collection') renderCollection();

        lucide.createIcons(); 
    }

    function renderMenu() {
        app.innerHTML = `
            <div class="flex flex-col h-full bg-white sm:bg-indigo-50">
                <!-- Header -->
                <div class="bg-white p-4 shadow-sm flex justify-between items-center z-10 sticky top-0">
                    <h1 class="text-xl font-bold text-indigo-600 flex items-center gap-2">
                        <i data-lucide="gift" class="text-pink-500"></i> Gacha DX
                    </h1>
                    <div class="bg-yellow-100 px-4 py-1 rounded-full flex items-center gap-2 text-yellow-700 font-bold border border-yellow-300">
                        <i data-lucide="coins" class="fill-yellow-400 text-yellow-600 w-5 h-5"></i>
                        ${state.coins}
                    </div>
                </div>

                <!-- Main Content -->
                <div class="flex-1 flex flex-col items-center justify-center p-6 gap-6 overflow-y-auto">
                    <div class="text-center mb-4">
                        <p class="text-gray-500 mb-2 font-bold">Collect all 100 words!</p>
                        <span class="text-xs bg-gray-200 px-2 py-1 rounded text-gray-600 font-mono">
                            ${state.collection.length} / ${VOCABULARY.length}
                        </span>
                    </div>

                    <button onclick="startGame()" class="w-full max-w-sm bg-gradient-to-r from-blue-400 to-blue-500 text-white p-6 rounded-3xl shadow-lg transform active:scale-95 transition-all flex items-center justify-between group">
                        <div class="flex items-center gap-4">
                            <div class="bg-white/20 p-3 rounded-2xl">
                                <i data-lucide="play" class="w-8 h-8 fill-current"></i>
                            </div>
                            <div class="text-left">
                                <div class="text-2xl font-bold">Play Game</div>
                                <div class="text-blue-100 text-sm">Get Coins!</div>
                            </div>
                        </div>
                        <div class="text-4xl group-hover:rotate-12 transition-transform">ğŸˆ</div>
                    </button>

                    <button onclick="state.screen='gacha'; render()" class="w-full max-w-sm bg-gradient-to-r from-pink-400 to-pink-500 text-white p-6 rounded-3xl shadow-lg transform active:scale-95 transition-all flex items-center justify-between group">
                        <div class="flex items-center gap-4">
                            <div class="bg-white/20 p-3 rounded-2xl">
                                <i data-lucide="shopping-bag" class="w-8 h-8"></i>
                            </div>
                            <div class="text-left">
                                <div class="text-2xl font-bold">Gacha Shop</div>
                                <div class="text-pink-100 text-sm">${GACHA_COST} coins</div>
                            </div>
                        </div>
                        <div class="text-4xl group-hover:rotate-12 transition-transform">ğŸ’Š</div>
                    </button>

                    <button onclick="state.screen='collection'; render()" class="w-full max-w-sm bg-white text-indigo-600 p-6 rounded-3xl shadow-md border-2 border-indigo-100 transform active:scale-95 transition-all flex items-center justify-between">
                        <div class="flex items-center gap-4">
                            <div class="bg-indigo-50 p-3 rounded-2xl">
                                <i data-lucide="book-open" class="w-8 h-8"></i>
                            </div>
                            <div class="text-left">
                                <div class="text-2xl font-bold">Collection</div>
                                <div class="text-gray-400 text-sm">Check items</div>
                            </div>
                        </div>
                        <div class="text-4xl">ğŸ“–</div>
                    </button>
                </div>

                <div class="p-4 flex justify-center bg-white sm:bg-transparent">
                    <button onclick="resetData()" class="text-gray-300 hover:text-red-400 flex gap-1 text-xs items-center">
                        <i data-lucide="settings" class="w-3 h-3"></i> Reset Data
                    </button>
                </div>
            </div>
        `;
    }

    function renderGame() {
        const q = state.gameData.questions[state.gameData.currentIdx];
        
        let balloonsHtml = q.options.map((opt, idx) => {
            const isTarget = opt.id === q.target.id;
            const isVisible = !state.gameData.answered || (state.gameData.answered && isTarget);
            const styleOpacity = state.gameData.answered && !isTarget ? 'opacity: 0;' : 'opacity: 1;';
            // Randomize position slightly for visual variety
            const leftPos = 10 + (idx * 30);
            const styleAnim = state.gameData.answered ? '' : `animation: float 3s infinite ease-in-out ${idx * 0.5}s alternate;`;
            
            return `
                <button
                    onclick="handleBalloonClick('${opt.id}')"
                    class="absolute transition-all duration-500 ease-in-out transform hover:scale-110 active:scale-90 flex flex-col items-center justify-center w-28 h-32 z-20"
                    style="left: ${leftPos}%; top: ${state.gameData.answered ? '15%' : '35%'}; ${styleAnim} ${styleOpacity}"
                >
                    <div class="w-24 h-28 rounded-[50%] rounded-b-[45%] ${opt.bg} border-b-4 border-black/5 shadow-xl relative flex items-center justify-center text-5xl">
                        ${opt.icon}
                        <div class="absolute -bottom-6 w-0.5 h-8 bg-gray-400/50"></div>
                        <div class="absolute top-4 right-4 w-4 h-8 bg-white/40 rounded-full rotate-[-15deg]"></div>
                    </div>
                </button>
            `;
        }).join('');

        app.innerHTML = `
            <div class="min-h-screen bg-sky-100 relative overflow-hidden flex flex-col h-full">
                <!-- Clouds -->
                <i data-lucide="cloud" class="absolute top-10 left-10 text-white/60 w-24 h-24"></i>
                <i data-lucide="cloud" class="absolute top-20 right-20 text-white/40 w-32 h-32"></i>
                <i data-lucide="cloud" class="absolute top-60 left-1/3 text-white/30 w-16 h-16"></i>

                <!-- Header -->
                <div class="p-4 flex justify-between items-center z-10">
                    <div class="flex gap-1">
                        ${[...Array(5)].map((_, i) => `
                            <div class="h-2 w-8 rounded-full ${i < state.gameData.currentIdx ? 'bg-green-400' : 'bg-gray-300'}"></div>
                        `).join('')}
                    </div>
                    <button onclick="speak('${q.target.word}')" class="bg-white p-3 rounded-full shadow-lg text-blue-500 active:scale-90 transition-transform">
                        <i data-lucide="volume-2" class="w-6 h-6"></i>
                    </button>
                </div>

                <!-- Prompt -->
                <div class="text-center mt-4 z-10 pointer-events-none">
                    <h2 class="text-gray-500 font-bold">Find:</h2>
                    <div class="text-4xl font-extrabold text-blue-900 drop-shadow-sm tracking-wide animate-pulse">${q.target.word}</div>
                </div>

                <!-- Balloons -->
                <div class="flex-1 relative mt-4">
                    ${balloonsHtml}
                </div>
            </div>
        `;
    }

    function renderResult() {
        app.innerHTML = `
            <div class="min-h-screen bg-yellow-50 flex flex-col items-center justify-center p-6">
                <div class="bg-white p-8 rounded-3xl shadow-xl w-full max-w-sm text-center border-4 border-yellow-200">
                    <div class="flex justify-center mb-4">
                        <i data-lucide="trophy" class="w-16 h-16 text-yellow-500"></i>
                    </div>
                    <h2 class="text-3xl font-bold text-gray-800 mb-2">Finish!</h2>
                    <div class="text-gray-500 mb-6">Score: ${state.gameData.finalScore} / 5</div>
                    
                    <div class="bg-yellow-100 p-4 rounded-xl mb-8 flex flex-col items-center animate-bounce">
                        <span class="text-sm text-yellow-700 font-bold">GET COINS</span>
                        <div class="flex items-center gap-2 text-4xl font-extrabold text-yellow-600">
                            <i data-lucide="coins" class="w-8 h-8 fill-current"></i> +${state.gameData.finalReward}
                        </div>
                    </div>

                    <div class="space-y-3">
                        <button onclick="startGame()" class="w-full bg-blue-500 text-white py-4 rounded-2xl font-bold shadow-md active:scale-95 transition-transform">
                            Play Again
                        </button>
                        <button onclick="state.screen='menu'; render()" class="w-full bg-white text-gray-500 border-2 border-gray-200 py-3 rounded-2xl font-bold active:scale-95 transition-transform">
                            Back to Menu
                        </button>
                    </div>
                </div>
            </div>
        `;
    }

    function renderGacha() {
        let modalHtml = '';
        if (state.gachaState === 'open' && state.gachaResult) {
            const r = state.gachaResult;
            let rarityText = "Common";
            let rarityColor = "text-gray-400";
            let bgEffect = "bg-yellow-100 opacity-20";
            
            if(r.rarity === 2) { rarityText = "Rare!"; rarityColor = "text-blue-500"; }
            if(r.rarity === 3) { rarityText = "Super Rare!"; rarityColor = "text-pink-500"; }
            if(r.rarity === 4) { rarityText = "ULTRA RARE!!"; rarityColor = "text-yellow-600 font-black"; bgEffect = "bg-gradient-to-r from-yellow-200 to-pink-200 opacity-50"; }

            modalHtml = `
                <div class="fixed inset-0 bg-black/80 flex items-center justify-center z-50 p-4">
                    <div class="bg-white w-full max-w-sm rounded-3xl p-8 text-center relative overflow-hidden animate-in fade-in zoom-in duration-300">
                         <div class="absolute inset-0 ${bgEffect} animate-spin-slow" style="z-index:-1"></div>
                        <div class="${rarityColor} font-bold mb-4 uppercase tracking-widest text-lg">${rarityText}</div>
                        <div class="text-8xl mb-6 transform hover:scale-110 transition-transform">${r.icon}</div>
                        <h3 class="text-4xl font-extrabold text-gray-800 mb-2">${r.word}</h3>
                        <p class="text-gray-500 text-xl mb-8">${r.jp}</p>
                        <button onclick="speak('${r.word}'); closeGacha()" class="w-full bg-pink-500 text-white font-bold py-4 rounded-xl shadow-lg active:scale-95">Close</button>
                    </div>
                </div>
            `;
        }

        const btnClass = state.gachaState === 'spinning' ? 'rotate-180 bg-pink-700' : 'bg-pink-400 hover:bg-pink-300';
        const btnDisabled = state.coins < GACHA_COST || state.gachaState !== 'idle';
        const btnOpacity = btnDisabled ? 'opacity-50 grayscale cursor-not-allowed' : 'active:scale-95 cursor-pointer';

        app.innerHTML = `
            <div class="min-h-screen bg-pink-50 flex flex-col items-center p-4">
                <div class="w-full flex justify-between items-center mb-4">
                    <button onclick="state.screen='menu'; render()" class="bg-white p-2 rounded-full shadow text-gray-500">
                        <i data-lucide="x" class="w-6 h-6"></i>
                    </button>
                    <div class="bg-yellow-100 px-4 py-1 rounded-full flex items-center gap-2 text-yellow-700 font-bold border border-yellow-300">
                        <i data-lucide="coins" class="fill-yellow-400 w-4 h-4"></i> ${state.coins}
                    </div>
                </div>

                <div class="flex-1 flex flex-col justify-center w-full max-w-sm">
                    <div class="bg-white p-6 rounded-3xl shadow-2xl border-4 border-pink-200 w-full flex flex-col items-center relative">
                        <div class="w-56 h-56 rounded-full bg-blue-100 border-4 border-black/10 flex items-center justify-center relative overflow-hidden mb-6">
                            <div class="absolute top-10 left-10 text-3xl animate-pulse">ğŸ’Š</div>
                            <div class="absolute bottom-10 right-10 text-3xl animate-pulse delay-75">ğŸ”®</div>
                            <div class="absolute top-1/2 left-1/2 text-3xl animate-pulse delay-150">ğŸ”´</div>
                            ${state.gachaState === 'spinning' ? `
                                <div class="absolute inset-0 bg-white/50 flex items-center justify-center">
                                    <i data-lucide="refresh-cw" class="animate-spin text-blue-500 w-16 h-16"></i>
                                </div>
                            ` : ''}
                        </div>
                        
                        <div class="w-full bg-pink-500 h-28 rounded-2xl flex items-center justify-center relative shadow-inner">
                            <button 
                                onclick="spinGacha()"
                                ${btnDisabled ? 'disabled' : ''}
                                class="h-20 w-20 rounded-full border-4 border-white shadow-lg flex items-center justify-center transition-all duration-500 ${btnClass} ${btnOpacity}"
                            >
                                <i data-lucide="rotate-cw" class="text-white w-10 h-10"></i>
                            </button>
                        </div>
                        <div class="mt-4 text-gray-400 text-sm font-bold">Cost: ${GACHA_COST} coins</div>
                    </div>
                </div>
                ${modalHtml}
            </div>
        `;
    }

    function renderCollection() {
        // Sort by Rarity (descending) then by ID
        const sortedVocab = [...VOCABULARY].sort((a,b) => b.rarity - a.rarity);

        const gridHtml = sortedVocab.map(item => {
            const isUnlocked = state.collection.includes(item.id);
            const clickHandler = isUnlocked ? `onclick="speak('${item.word}')"` : '';
            
            // Style logic based on rarity/unlock
            let cardBg = isUnlocked ? 'bg-white' : 'bg-gray-200 opacity-50';
            if(isUnlocked && item.rarity === 4) cardBg = 'bg-yellow-50 border-2 border-yellow-200';
            
            const icon = isUnlocked ? item.icon : 'ğŸ”’';
            
            let stars = '';
            if(isUnlocked) {
                // Gold stars for normal, Rainbowish for Ultra Rare? Just standard gold for clean look
                stars = `<div class="flex gap-0.5 mt-1">${[...Array(item.rarity)].map(() => '<span class="text-[8px] text-yellow-500">â˜…</span>').join('')}</div>`;
            }

            return `
                <div ${clickHandler} class="aspect-square rounded-2xl flex flex-col items-center justify-center p-1 transition-all shadow-sm ${cardBg} ${isUnlocked ? 'active:scale-95 cursor-pointer' : ''}">
                    <div class="text-3xl sm:text-4xl mb-1 filter">${icon}</div>
                    ${isUnlocked ? `
                        <div class="text-[10px] sm:text-xs font-bold text-gray-700 truncate w-full text-center">${item.word}</div>
                        <div class="text-[8px] sm:text-[10px] text-gray-400 truncate">${item.jp}</div>
                    ` : ''}
                    ${stars}
                </div>
            `;
        }).join('');

        app.innerHTML = `
            <div class="h-screen bg-indigo-50 flex flex-col overflow-hidden">
                <div class="bg-white p-4 shadow-sm flex justify-between items-center z-10 sticky top-0">
                    <button onclick="state.screen='menu'; render()" class="bg-gray-100 p-2 rounded-full">
                        <i data-lucide="x" class="w-5 h-5"></i>
                    </button>
                    <h1 class="text-lg font-bold text-gray-700">Collection</h1>
                    <div class="w-8"></div>
                </div>
                
                <div class="flex-1 p-4 grid grid-cols-4 sm:grid-cols-5 gap-2 overflow-y-auto collection-scroll content-start pb-20">
                    ${gridHtml}
                </div>
            </div>
        `;
    }

    // --- Init ---
    render();
</script>
</body>
</html>


