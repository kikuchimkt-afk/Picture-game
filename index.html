<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>English Gacha World</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @keyframes float {
            0% { transform: translateY(0px); }
            100% { transform: translateY(-20px); }
        }
        @keyframes spin-slow {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        .animate-spin-slow {
            animation: spin-slow 10s linear infinite;
        }
        .balloon-float {
            animation: float 3s infinite ease-in-out alternate;
        }
        /* Gacha animation classes */
        .gacha-shake {
            animation: shake 0.5s cubic-bezier(.36,.07,.19,.97) both;
        }
        @keyframes shake {
            10%, 90% { transform: translate3d(-1px, 0, 0); }
            20%, 80% { transform: translate3d(2px, 0, 0); }
            30%, 50%, 70% { transform: translate3d(-4px, 0, 0); }
            40%, 60% { transform: translate3d(4px, 0, 0); }
        }
    </style>
</head>
<body class="bg-indigo-50 min-h-screen font-sans select-none touch-manipulation">

    <div id="app" class="max-w-md mx-auto min-h-screen bg-indigo-50 relative shadow-2xl overflow-hidden">
        <!-- Content will be rendered here by JavaScript -->
    </div>

<script>
    // --- „Éá„Éº„ÇøÂÆöÁæ© ---
    const VOCABULARY = [
        // Common (‚òÖ1)
        { id: 'apple', word: 'Apple', jp: '„Çä„Çì„Åî', icon: 'üçé', rarity: 1, bg: 'bg-red-50' },
        { id: 'banana', word: 'Banana', jp: '„Éê„Éä„Éä', icon: 'üçå', rarity: 1, bg: 'bg-yellow-50' },
        { id: 'cat', word: 'Cat', jp: '„Å≠„Åì', icon: 'üê±', rarity: 1, bg: 'bg-orange-50' },
        { id: 'dog', word: 'Dog', jp: '„ÅÑ„Å¨', icon: 'üê∂', rarity: 1, bg: 'bg-amber-50' },
        { id: 'car', word: 'Car', jp: '„Åè„Çã„Åæ', icon: 'üöó', rarity: 1, bg: 'bg-blue-50' },
        { id: 'bus', word: 'Bus', jp: '„Éê„Çπ', icon: 'üöå', rarity: 1, bg: 'bg-blue-100' },
        { id: 'sun', word: 'Sun', jp: '„Åü„ÅÑ„Çà„ÅÜ', icon: '‚òÄÔ∏è', rarity: 1, bg: 'bg-orange-100' },
        { id: 'flower', word: 'Flower', jp: '„Åä„ÅØ„Å™', icon: 'üå∏', rarity: 1, bg: 'bg-pink-50' },
        { id: 'ball', word: 'Ball', jp: '„Éú„Éº„É´', icon: '‚öΩ', rarity: 1, bg: 'bg-slate-50' },
        { id: 'book', word: 'Book', jp: '„Åª„Çì', icon: 'üìö', rarity: 1, bg: 'bg-indigo-50' },
        { id: 'fish', word: 'Fish', jp: '„Åï„Åã„Å™', icon: 'üêü', rarity: 1, bg: 'bg-cyan-50' },
        { id: 'egg', word: 'Egg', jp: '„Åü„Åæ„Åî', icon: 'ü•ö', rarity: 1, bg: 'bg-stone-50' },
        { id: 'milk', word: 'Milk', jp: '„Åé„ÇÖ„ÅÜ„Å´„ÇÖ„ÅÜ', icon: 'ü•õ', rarity: 1, bg: 'bg-blue-50' },
        { id: 'bread', word: 'Bread', jp: '„Éë„É≥', icon: 'üçû', rarity: 1, bg: 'bg-orange-50' },
        { id: 'shirt', word: 'Shirt', jp: '„Ç∑„É£„ÉÑ', icon: 'üëï', rarity: 1, bg: 'bg-sky-50' },

        // Rare (‚òÖ2)
        { id: 'grape', word: 'Grape', jp: '„Å∂„Å©„ÅÜ', icon: 'üçá', rarity: 2, bg: 'bg-purple-100' },
        { id: 'lion', word: 'Lion', jp: '„É©„Ç§„Ç™„É≥', icon: 'ü¶Å', rarity: 2, bg: 'bg-yellow-100' },
        { id: 'panda', word: 'Panda', jp: '„Éë„É≥„ÉÄ', icon: 'üêº', rarity: 2, bg: 'bg-stone-100' },
        { id: 'train', word: 'Train', jp: '„Åß„Çì„Åó„ÇÉ', icon: 'üöÉ', rarity: 2, bg: 'bg-emerald-100' },
        { id: 'plane', word: 'Plane', jp: '„Å≤„Åì„ÅÜ„Åç', icon: '‚úàÔ∏è', rarity: 2, bg: 'bg-sky-100' },
        { id: 'cake', word: 'Cake', jp: '„Ç±„Éº„Ç≠', icon: 'üç∞', rarity: 2, bg: 'bg-rose-100' },
        { id: 'icecream', word: 'Ice Cream', jp: '„Ç¢„Ç§„Çπ', icon: 'üç¶', rarity: 2, bg: 'bg-pink-100' },
        { id: 'robot', word: 'Robot', jp: '„É≠„Éú„ÉÉ„Éà', icon: 'ü§ñ', rarity: 2, bg: 'bg-gray-200' },
        { id: 'bear', word: 'Bear', jp: '„Åè„Åæ', icon: 'üêª', rarity: 2, bg: 'bg-amber-200' },
        { id: 'frog', word: 'Frog', jp: '„Åã„Åà„Çã', icon: 'üê∏', rarity: 2, bg: 'bg-green-100' },
        { id: 'star', word: 'Star', jp: '„Åª„Åó', icon: '‚≠ê', rarity: 2, bg: 'bg-yellow-100' },
        { id: 'moon', word: 'Moon', jp: '„Å§„Åç', icon: 'üåô', rarity: 2, bg: 'bg-indigo-100' },
        { id: 'music', word: 'Music', jp: '„Åä„Çì„Åå„Åè', icon: 'üéµ', rarity: 2, bg: 'bg-fuchsia-100' },
        { id: 'camera', word: 'Camera', jp: '„Ç´„É°„É©', icon: 'üì∑', rarity: 2, bg: 'bg-stone-200' },
        { id: 'burger', word: 'Burger', jp: '„Éè„É≥„Éê„Éº„Ç¨„Éº', icon: 'üçî', rarity: 2, bg: 'bg-orange-200' },

        // Super Rare (‚òÖ3)
        { id: 'unicorn', word: 'Unicorn', jp: '„É¶„Éã„Ç≥„Éº„É≥', icon: 'ü¶Ñ', rarity: 3, bg: 'bg-purple-200' },
        { id: 'dragon', word: 'Dragon', jp: '„Éâ„É©„Ç¥„É≥', icon: 'üêâ', rarity: 3, bg: 'bg-emerald-200' },
        { id: 'rocket', word: 'Rocket', jp: '„É≠„Ç±„ÉÉ„Éà', icon: 'üöÄ', rarity: 3, bg: 'bg-indigo-200' },
        { id: 'crown', word: 'Crown', jp: '„Åä„ÅÜ„Åã„Çì', icon: 'üëë', rarity: 3, bg: 'bg-yellow-200' },
        { id: 'diamond', word: 'Diamond', jp: '„Åª„ÅÜ„Åõ„Åç', icon: 'üíé', rarity: 3, bg: 'bg-cyan-200' },
        { id: 'ghost', word: 'Ghost', jp: '„Åä„Å∞„Åë', icon: 'üëª', rarity: 3, bg: 'bg-slate-300' },
        { id: 'alien', word: 'Alien', jp: '„ÅÜ„Å°„ÇÖ„ÅÜ„Åò„Çì', icon: 'üëΩ', rarity: 3, bg: 'bg-green-300' },
        { id: 'santa', word: 'Santa', jp: '„Çµ„É≥„Çø', icon: 'üéÖ', rarity: 3, bg: 'bg-red-200' },
        { id: 'present', word: 'Gift', jp: '„Éó„É¨„Çº„É≥„Éà', icon: 'üéÅ', rarity: 3, bg: 'bg-rose-200' },
        { id: 'rainbow', word: 'Rainbow', jp: '„Å´„Åò', icon: 'üåà', rarity: 3, bg: 'bg-sky-200' },
    ];

    const GACHA_COST = 100;
    const REWARD_PER_GAME = 10;
    const PERFECT_BONUS = 20;

    // --- State Management ---
    let state = {
        coins: parseInt(localStorage.getItem('kids_eng_coins')) || 0,
        collection: JSON.parse(localStorage.getItem('kids_eng_collection')) || [],
        screen: 'menu', // menu, game, gacha, result, collection
        gameData: null,
        gachaState: 'idle', // idle, spinning, open
        gachaResult: null
    };

    // --- Helpers ---
    function saveState() {
        localStorage.setItem('kids_eng_coins', state.coins);
        localStorage.setItem('kids_eng_collection', JSON.stringify(state.collection));
        render();
    }

    function speak(text) {
        if (!window.speechSynthesis) return;
        window.speechSynthesis.cancel();
        const u = new SpeechSynthesisUtterance(text);
        u.lang = 'en-US';
        u.rate = 1.0;
        window.speechSynthesis.speak(u);
    }

    function playSfx(type) {
        const AudioContext = window.AudioContext || window.webkitAudioContext;
        if (!AudioContext) return;
        const ctx = new AudioContext();
        const osc = ctx.createOscillator();
        const gain = ctx.createGain();
        osc.connect(gain);
        gain.connect(ctx.destination);
        const now = ctx.currentTime;

        if (type === 'pop') {
            osc.type = 'triangle';
            osc.frequency.setValueAtTime(400, now);
            osc.frequency.exponentialRampToValueAtTime(800, now + 0.1);
            gain.gain.setValueAtTime(0.1, now);
            gain.gain.linearRampToValueAtTime(0, now + 0.1);
            osc.start();
            osc.stop(now + 0.1);
        } else if (type === 'coin') {
            osc.type = 'sine';
            osc.frequency.setValueAtTime(1000, now);
            osc.frequency.setValueAtTime(1500, now + 0.1);
            gain.gain.setValueAtTime(0.1, now);
            gain.gain.linearRampToValueAtTime(0, now + 0.3);
            osc.start();
            osc.stop(now + 0.3);
        } else if (type === 'gacha') {
            osc.type = 'square';
            osc.frequency.setValueAtTime(200, now);
            osc.frequency.linearRampToValueAtTime(100, now + 0.5);
            gain.gain.setValueAtTime(0.05, now);
            gain.gain.linearRampToValueAtTime(0, now + 0.5);
            osc.start();
            osc.stop(now + 0.5);
        }
    }

    // --- Game Logic ---
    function startGame() {
        const questions = [];
        for(let i=0; i<5; i++) {
            const target = VOCABULARY[Math.floor(Math.random() * VOCABULARY.length)];
            const distractors = [];
            while(distractors.length < 2) {
                const d = VOCABULARY[Math.floor(Math.random() * VOCABULARY.length)];
                if (d.id !== target.id && !distractors.find(x => x.id === d.id)) distractors.push(d);
            }
            const options = [target, ...distractors].sort(() => 0.5 - Math.random());
            questions.push({ target, options });
        }
        
        state.gameData = { 
            questions, 
            currentIdx: 0, 
            score: 0, 
            answered: false 
        };
        state.screen = 'game';
        render();
        
        setTimeout(() => speak(questions[0].target.word), 600);
    }

    function handleBalloonClick(itemId) {
        if (state.gameData.answered) return;
        
        const currentQ = state.gameData.questions[state.gameData.currentIdx];
        const isCorrect = itemId === currentQ.target.id;
        const clickedItem = currentQ.options.find(o => o.id === itemId);

        state.gameData.answered = true;
        render(); // Update visual state

        if (isCorrect) {
            playSfx('pop');
            speak("Good!");
            state.gameData.score++;
        } else {
            speak(clickedItem.word);
        }

        setTimeout(() => {
            if (state.gameData.currentIdx < 4) {
                state.gameData.currentIdx++;
                state.gameData.answered = false;
                render();
                speak(state.gameData.questions[state.gameData.currentIdx].target.word);
            } else {
                // End Game
                const finalScore = isCorrect ? state.gameData.score : state.gameData.score; // Already incremented
                const reward = (finalScore * REWARD_PER_GAME) + (finalScore === 5 ? PERFECT_BONUS : 0);
                
                state.coins += reward;
                if (finalScore > 0) playSfx('coin');
                
                state.gameData.finalReward = reward;
                state.gameData.finalScore = finalScore;
                state.screen = 'result';
                saveState(); // Renders automatically
            }
        }, 1500);
    }

    // --- Gacha Logic ---
    function spinGacha() {
        if (state.coins < GACHA_COST || state.gachaState !== 'idle') return;
        
        state.coins -= GACHA_COST;
        state.gachaState = 'spinning';
        playSfx('gacha');
        saveState();

        setTimeout(() => {
            const rand = Math.random();
            let pool = [];
            if (rand < 0.6) pool = VOCABULARY.filter(v => v.rarity === 1);
            else if (rand < 0.9) pool = VOCABULARY.filter(v => v.rarity === 2);
            else pool = VOCABULARY.filter(v => v.rarity === 3);
            
            const result = pool[Math.floor(Math.random() * pool.length)];
            state.gachaResult = result;
            state.gachaState = 'open';
            
            if (!state.collection.includes(result.id)) {
                state.collection.push(result.id);
            }
            saveState();
        }, 2000);
    }

    function closeGacha() {
        state.gachaState = 'idle';
        state.gachaResult = null;
        render();
    }

    function resetData() {
        if(confirm('Are you sure you want to reset all data? (Coins and Collection will be lost)')) {
            state.coins = 0;
            state.collection = [];
            state.screen = 'menu';
            saveState();
        }
    }

    // --- Rendering ---
    const app = document.getElementById('app');

    function render() {
        app.innerHTML = ''; // Clear

        if (state.screen === 'menu') renderMenu();
        else if (state.screen === 'game') renderGame();
        else if (state.screen === 'result') renderResult();
        else if (state.screen === 'gacha') renderGacha();
        else if (state.screen === 'collection') renderCollection();

        lucide.createIcons(); // Initialize icons
    }

    function renderMenu() {
        app.innerHTML = `
            <div class="flex flex-col h-full">
                <!-- Header -->
                <div class="bg-white p-4 shadow-sm flex justify-between items-center z-10">
                    <h1 class="text-xl font-bold text-indigo-600 flex items-center gap-2">
                        <i data-lucide="gift" class="text-pink-500"></i> English Gacha
                    </h1>
                    <div class="bg-yellow-100 px-4 py-1 rounded-full flex items-center gap-2 text-yellow-700 font-bold border border-yellow-300">
                        <i data-lucide="coins" class="fill-yellow-400 text-yellow-600 w-5 h-5"></i>
                        ${state.coins}
                    </div>
                </div>

                <!-- Main Content -->
                <div class="flex-1 flex flex-col items-center justify-center p-6 gap-6">
                    <div class="text-center mb-4">
                        <p class="text-gray-500 mb-2 font-bold">Collect them all!</p>
                        <span class="text-xs bg-gray-200 px-2 py-1 rounded text-gray-600">
                            Collection: ${state.collection.length} / ${VOCABULARY.length}
                        </span>
                    </div>

                    <button onclick="startGame()" class="w-full max-w-sm bg-gradient-to-r from-blue-400 to-blue-500 text-white p-6 rounded-3xl shadow-lg transform active:scale-95 transition-all flex items-center justify-between group">
                        <div class="flex items-center gap-4">
                            <div class="bg-white/20 p-3 rounded-2xl">
                                <i data-lucide="play" class="w-8 h-8 fill-current"></i>
                            </div>
                            <div class="text-left">
                                <div class="text-2xl font-bold">Play Game</div>
                                <div class="text-blue-100 text-sm">Get Coins!</div>
                            </div>
                        </div>
                        <div class="text-4xl group-hover:rotate-12 transition-transform">üéà</div>
                    </button>

                    <button onclick="state.screen='gacha'; render()" class="w-full max-w-sm bg-gradient-to-r from-pink-400 to-pink-500 text-white p-6 rounded-3xl shadow-lg transform active:scale-95 transition-all flex items-center justify-between group">
                        <div class="flex items-center gap-4">
                            <div class="bg-white/20 p-3 rounded-2xl">
                                <i data-lucide="shopping-bag" class="w-8 h-8"></i>
                            </div>
                            <div class="text-left">
                                <div class="text-2xl font-bold">Gacha Shop</div>
                                <div class="text-pink-100 text-sm">${GACHA_COST} coins / play</div>
                            </div>
                        </div>
                        <div class="text-4xl group-hover:rotate-12 transition-transform">üíä</div>
                    </button>

                    <button onclick="state.screen='collection'; render()" class="w-full max-w-sm bg-white text-indigo-600 p-6 rounded-3xl shadow-md border-2 border-indigo-100 transform active:scale-95 transition-all flex items-center justify-between">
                        <div class="flex items-center gap-4">
                            <div class="bg-indigo-50 p-3 rounded-2xl">
                                <i data-lucide="book-open" class="w-8 h-8"></i>
                            </div>
                            <div class="text-left">
                                <div class="text-2xl font-bold">Collection</div>
                                <div class="text-gray-400 text-sm">Check your items</div>
                            </div>
                        </div>
                        <div class="text-4xl">üìñ</div>
                    </button>
                </div>

                <div class="p-4 flex justify-center">
                    <button onclick="resetData()" class="text-gray-300 hover:text-red-400 flex gap-1 text-xs items-center">
                        <i data-lucide="settings" class="w-3 h-3"></i> Reset Data
                    </button>
                </div>
            </div>
        `;
    }

    function renderGame() {
        const q = state.gameData.questions[state.gameData.currentIdx];
        
        let balloonsHtml = q.options.map((opt, idx) => {
            const isTarget = opt.id === q.target.id;
            const isVisible = !state.gameData.answered || (state.gameData.answered && isTarget);
            const styleOpacity = state.gameData.answered && !isTarget ? 'opacity: 0;' : 'opacity: 1;';
            const styleAnim = state.gameData.answered ? '' : `animation: float 3s infinite ease-in-out ${idx * 0.5}s alternate;`;
            
            return `
                <button
                    onclick="handleBalloonClick('${opt.id}')"
                    class="absolute transition-all duration-1000 ease-in-out transform hover:scale-110 active:scale-90 flex flex-col items-center justify-center w-28 h-32"
                    style="left: ${10 + (idx * 30)}%; top: ${state.gameData.answered ? '10%' : '30%'}; ${styleAnim} ${styleOpacity}"
                >
                    <div class="w-24 h-28 rounded-[50%] rounded-b-[45%] ${opt.bg} border-b-4 border-black/5 shadow-xl relative flex items-center justify-center text-5xl">
                        ${opt.icon}
                        <div class="absolute -bottom-6 w-0.5 h-8 bg-gray-400/50"></div>
                        <div class="absolute top-4 right-4 w-4 h-8 bg-white/40 rounded-full rotate-[-15deg]"></div>
                    </div>
                </button>
            `;
        }).join('');

        app.innerHTML = `
            <div class="min-h-screen bg-sky-100 relative overflow-hidden flex flex-col h-full">
                <!-- Clouds -->
                <i data-lucide="cloud" class="absolute top-10 left-10 text-white/60 w-24 h-24"></i>
                <i data-lucide="cloud" class="absolute top-20 right-20 text-white/40 w-32 h-32"></i>

                <!-- Header -->
                <div class="p-4 flex justify-between items-center z-10">
                    <div class="flex gap-1">
                        ${[...Array(5)].map((_, i) => `
                            <div class="h-2 w-8 rounded-full ${i < state.gameData.currentIdx ? 'bg-green-400' : 'bg-gray-300'}"></div>
                        `).join('')}
                    </div>
                    <button onclick="speak('${q.target.word}')" class="bg-white p-3 rounded-full shadow-lg text-blue-500 active:scale-90 transition-transform">
                        <i data-lucide="volume-2" class="w-6 h-6"></i>
                    </button>
                </div>

                <!-- Prompt -->
                <div class="text-center mt-4 z-10">
                    <h2 class="text-gray-500 font-bold">Find:</h2>
                    <div class="text-3xl font-extrabold text-blue-900 drop-shadow-sm">${q.target.word}</div>
                </div>

                <!-- Balloons -->
                <div class="flex-1 relative mt-8">
                    ${balloonsHtml}
                </div>
            </div>
        `;
    }

    function renderResult() {
        app.innerHTML = `
            <div class="min-h-screen bg-yellow-50 flex flex-col items-center justify-center p-6">
                <div class="bg-white p-8 rounded-3xl shadow-xl w-full max-w-sm text-center border-4 border-yellow-200">
                    <div class="flex justify-center mb-4">
                        <i data-lucide="trophy" class="w-16 h-16 text-yellow-500"></i>
                    </div>
                    <h2 class="text-3xl font-bold text-gray-800 mb-2">Finish!</h2>
                    <div class="text-gray-500 mb-6">Score: ${state.gameData.finalScore} / 5</div>
                    
                    <div class="bg-yellow-100 p-4 rounded-xl mb-8 flex flex-col items-center animate-bounce">
                        <span class="text-sm text-yellow-700 font-bold">GET COINS</span>
                        <div class="flex items-center gap-2 text-4xl font-extrabold text-yellow-600">
                            <i data-lucide="coins" class="w-8 h-8 fill-current"></i> +${state.gameData.finalReward}
                        </div>
                    </div>

                    <div class="space-y-3">
                        <button onclick="startGame()" class="w-full bg-blue-500 text-white py-4 rounded-2xl font-bold shadow-md active:scale-95 transition-transform">
                            Play Again
                        </button>
                        <button onclick="state.screen='menu'; render()" class="w-full bg-white text-gray-500 border-2 border-gray-200 py-3 rounded-2xl font-bold active:scale-95 transition-transform">
                            Back to Menu
                        </button>
                    </div>
                </div>
            </div>
        `;
    }

    function renderGacha() {
        // Modal Logic within Gacha
        let modalHtml = '';
        if (state.gachaState === 'open' && state.gachaResult) {
            const r = state.gachaResult;
            const rarityText = r.rarity === 3 ? "Super Rare!" : r.rarity === 2 ? "Rare!" : "Common";
            modalHtml = `
                <div class="fixed inset-0 bg-black/70 flex items-center justify-center z-50 p-4">
                    <div class="bg-white w-full max-w-sm rounded-3xl p-8 text-center relative overflow-hidden animate-bounce">
                         <div class="absolute inset-0 bg-yellow-100 opacity-20 animate-spin-slow" style="z-index:-1"></div>
                        <div class="text-gray-400 font-bold mb-4 uppercase tracking-widest">${rarityText}</div>
                        <div class="text-8xl mb-4">${r.icon}</div>
                        <h3 class="text-3xl font-extrabold text-gray-800 mb-2">${r.word}</h3>
                        <p class="text-gray-500 text-xl mb-8">${r.jp}</p>
                        <button onclick="speak('${r.word}'); closeGacha()" class="w-full bg-pink-500 text-white font-bold py-4 rounded-xl shadow-lg active:scale-95">Close</button>
                    </div>
                </div>
            `;
        }

        const btnClass = state.gachaState === 'spinning' ? 'rotate-180 bg-pink-700' : 'bg-pink-400 hover:bg-pink-300';
        const btnDisabled = state.coins < GACHA_COST || state.gachaState !== 'idle';
        const btnOpacity = btnDisabled ? 'opacity-50 grayscale cursor-not-allowed' : 'active:scale-95 cursor-pointer';

        app.innerHTML = `
            <div class="min-h-screen bg-pink-50 flex flex-col items-center p-4">
                <div class="w-full flex justify-between items-center mb-8">
                    <button onclick="state.screen='menu'; render()" class="bg-white p-2 rounded-full shadow text-gray-500">
                        <i data-lucide="x" class="w-6 h-6"></i>
                    </button>
                    <div class="bg-yellow-100 px-4 py-1 rounded-full flex items-center gap-2 text-yellow-700 font-bold border border-yellow-300">
                        <i data-lucide="coins" class="fill-yellow-400 w-4 h-4"></i> ${state.coins}
                    </div>
                </div>

                <div class="bg-white p-6 rounded-3xl shadow-2xl border-4 border-pink-200 w-full max-w-sm flex flex-col items-center relative">
                    <div class="w-48 h-48 rounded-full bg-blue-100 border-4 border-black/10 flex items-center justify-center relative overflow-hidden mb-4">
                         <div class="absolute top-10 left-10 text-2xl animate-pulse">üíä</div>
                         <div class="absolute bottom-10 right-10 text-2xl animate-pulse delay-75">üîÆ</div>
                         <div class="absolute top-1/2 left-1/2 text-2xl animate-pulse delay-150">üî¥</div>
                         ${state.gachaState === 'spinning' ? `
                            <div class="absolute inset-0 bg-white/50 flex items-center justify-center">
                                <i data-lucide="refresh-cw" class="animate-spin text-blue-500 w-12 h-12"></i>
                            </div>
                         ` : ''}
                    </div>
                    
                    <div class="w-full bg-pink-500 h-24 rounded-2xl flex items-center justify-center relative shadow-inner">
                        <button 
                            onclick="spinGacha()"
                            ${btnDisabled ? 'disabled' : ''}
                            class="h-16 w-16 rounded-full border-4 border-white shadow-lg flex items-center justify-center transition-all duration-500 ${btnClass} ${btnOpacity}"
                        >
                            <i data-lucide="rotate-cw" class="text-white w-8 h-8"></i>
                        </button>
                    </div>
                    <div class="mt-4 text-gray-400 text-sm font-bold">Cost: ${GACHA_COST} coins</div>
                </div>
                ${modalHtml}
            </div>
        `;
    }

    function renderCollection() {
        const gridHtml = VOCABULARY.map(item => {
            const isUnlocked = state.collection.includes(item.id);
            const clickHandler = isUnlocked ? `onclick="speak('${item.word}')"` : '';
            const bgClass = isUnlocked ? 'bg-white shadow-md cursor-pointer active:scale-95' : 'bg-gray-200 opacity-50';
            const icon = isUnlocked ? item.icon : 'üîí';
            
            let stars = '';
            if(isUnlocked) {
                stars = `<div class="flex gap-0.5 mt-1">${[...Array(item.rarity)].map(() => '<span class="text-[8px] text-yellow-500">‚òÖ</span>').join('')}</div>`;
            }

            return `
                <div ${clickHandler} class="aspect-square rounded-2xl flex flex-col items-center justify-center p-2 transition-all ${bgClass}">
                    <div class="text-3xl mb-1 filter">${icon}</div>
                    ${isUnlocked ? `
                        <div class="text-xs font-bold text-gray-700 truncate w-full text-center">${item.word}</div>
                        <div class="text-[10px] text-gray-400 truncate">${item.jp}</div>
                    ` : ''}
                    ${stars}
                </div>
            `;
        }).join('');

        app.innerHTML = `
            <div class="min-h-screen bg-indigo-50 flex flex-col">
                <div class="bg-white p-4 shadow-sm flex justify-between items-center z-10 sticky top-0">
                    <button onclick="state.screen='menu'; render()" class="bg-gray-100 p-2 rounded-full">
                        <i data-lucide="x" class="w-5 h-5"></i>
                    </button>
                    <h1 class="text-lg font-bold text-gray-700">Collection Book</h1>
                    <div class="w-8"></div>
                </div>
                
                <div class="p-4 grid grid-cols-3 sm:grid-cols-4 gap-3 overflow-y-auto pb-20">
                    ${gridHtml}
                </div>
            </div>
        `;
    }

    // --- Init ---
    render();
</script>
</body>
</html>

